# Tmux 教程：Linux 终端复用器

Tmux (终端复用器) 是一个强大的工具，允许你在单个窗口中管理多个终端会话。它对于运行长时间进程、组织工作流程以及维护即使在你断开服务器连接后仍然存在的会话特别有用。

## 什么是 Tmux？

Tmux 是一个终端复用器，这意味着它允许你在单个终端窗口中运行多个终端会话。可以将其视为终端的窗口管理器 - 它使你能够创建、访问和控制多个终端会话，每个会话都有多个窗口和面板。

Tmux 背后的核心概念是将终端（你的终端模拟器，如 gnome-terminal、iTerm2 等）与其中运行的会话分离。这种分离提供了强大的功能，这些功能在标准终端中是不可能实现的。

## Tmux 如何工作

Tmux 采用客户端-服务器架构运行：

1. **服务器**：当你首次运行 tmux 命令时，tmux 服务器进程在后台启动。该服务器管理所有会话、窗口和面板。

2. **会话**：会话是 tmux 的一个实例，可以包含多个窗口。每个会话都是独立的，可以连接到终端客户端或从中分离。

3. **客户端**：当你运行 tmux 命令时，实际上是创建了与 tmux 服务器的客户端连接。这些客户端显示会话中发生的情况。

这种架构赋予了 tmux 强大的持久性能力。即使所有客户端断开连接，服务器仍然继续运行，保持你的会话活跃。

## 为什么使用 Tmux？

Tmux 提供了几个关键优势，使其对基于终端的工作非常宝贵：

### 持久会话
Tmux 最强大的功能之一是会话持久性。即使你断开终端连接，你的会话也会继续运行。这在以下情况下特别有价值：
- 通过 SSH 在远程服务器上工作
- 运行需要数小时完成的长时间进程
- 意外断开终端会话连接

### 窗口和面板管理
Tmux 允许你高效组织终端工作：
- 在单个会话中创建多个窗口（类似浏览器标签）
- 将窗口分割成多个面板以进行多任务处理
- 根据需要调整和重新排列面板
- 在结构化布局中同时运行多个命令

### 提高生产力
Tmux 显著改善你的终端工作流程：
- 在不打开多个终端窗口的情况下切换不同项目或任务
- 在终端会话之间保持一致的工作环境
- 使用键盘快捷键快速在窗口和面板之间导航
- 在面板和会话之间复制和粘贴文本

## 安装 Tmux

在使用 tmux 之前，你需要安装它：

### Ubuntu/Debian:
```sh
sudo apt update
sudo apt install tmux
```

### CentOS/RHEL/Fedora:
```sh
# CentOS/RHEL
sudo yum install tmux

# Fedora
sudo dnf install tmux
```

### macOS:
```sh
# 使用 Homebrew
brew install tmux
```

## Tmux 基本概念

理解 tmux 的层次结构是有效使用它的关键：

- **会话**：顶级容器，可以包含多个窗口。会话是你连接和分离的对象。每个会话都有一个唯一的名称，可以被视为项目工作空间。

- **窗口**：类似于浏览器中的标签，窗口存在于会话中，可以包含一个或多个面板。每个窗口都有自己的面板集，可以独立运行不同的程序。

- **面板**：窗口内的单独终端视图。面板允许你在同一窗口内并排运行多个程序。你可以水平或垂直分割窗口来创建面板。

这种三级层次结构（会话 → 窗口 → 面板）为你的终端工作提供了强大的组织系统。例如，你可能有一个用于 Web 开发项目的会话，其中包含多个窗口（一个用于代码，一个用于日志，一个用于数据库），每个窗口都有多个面板（编辑器、终端、输出）。

## 启动 Tmux

根据你的需求，有几种启动 tmux 的方法：

### 创建新会话
要启动一个未命名的新 tmux 会话：
```sh
tmux
```

这将打开一个新的 tmux 会话，底部有一个状态栏显示会话信息。

### 创建命名会话
为了更好的组织，特别是在处理多个项目时，创建命名会话：
```sh
tmux new -s session_name
```

命名会话使识别和管理多个会话变得更容易。

### 连接到现有会话
要连接到现有会话：
```sh
tmux attach -t session_name
```

如果你只有一个会话，可以简单地使用：
```sh
tmux attach
```

### 理解状态栏
当你启动 tmux 时，你会注意到终端底部有一个状态栏。这个栏提供重要信息：
- 当前会话名称
- 窗口列表，活动窗口高亮显示
- 系统信息，如时间和日期
- 主机名

状态栏是你了解 tmux 中发生情况的主要视觉指示器，它可以自定义以显示额外信息。

## Tmux 键绑定

所有 tmux 命令都以前缀键开始。默认情况下，这是 `Ctrl+b`。按下前缀键后，你可以按另一个键来执行命令。

例如，要创建一个新窗口，你需要按 `Ctrl+b` 然后按 `c`。

### 理解前缀键机制

前缀键机制是 tmux 工作方式的核心。由于 tmux 在终端内运行，它需要一种方法来区分：
1. 你想发送给 tmux 内运行的程序的命令
2. 你想发送给 tmux 本身的命令

通过在 tmux 命令前要求前缀键，tmux 可以拦截这些命令，同时允许所有其他按键传递给你的程序。这就是为什么你可以在 tmux 内正常使用 vim、emacs 或任何其他基于终端的程序 - tmux 只捕获以前缀开始的特定按键组合。

### 为什么是 Ctrl+b？

默认前缀键 `Ctrl+b` 之所以被选择，是因为它很少被其他程序使用。然而，许多用户将其更改为 `Ctrl+a`（类似于 GNU Screen），因为它更容易用一只手按下。

### 命令模式

按下前缀键后，tmux 会短暂进入命令模式（可配置），在此期间它等待你的命令。如果你按错键或改变主意，可以按 `Esc` 或等待超时返回正常操作。

## 基本 Tmux 命令

### 会话管理
- `tmux new -s session_name` - 创建具有特定名称的新会话
- `tmux ls` - 列出所有会话
- `tmux attach -t session_name` - 连接到现有会话
- `tmux kill-session -t session_name` - 终止特定会话

### 在 Tmux 会话内
- `Ctrl+b d` - 从当前会话分离
- `Ctrl+b $` - 重命名当前会话
- `Ctrl+b s` - 列出所有会话并在它们之间切换

### 窗口管理
- `Ctrl+b c` - 创建新窗口
- `Ctrl+b n` - 切换到下一个窗口
- `Ctrl+b p` - 切换到上一个窗口
- `Ctrl+b w` - 列出所有窗口并选择一个
- `Ctrl+b ,` - 重命名当前窗口
- `Ctrl+b &` - 关闭当前窗口

### 面板管理
- `Ctrl+b %` - 垂直分割当前面板
- `Ctrl+b "` - 水平分割当前面板
- `Ctrl+b o` - 在面板之间切换
- `Ctrl+b ;` - 切换到上一个活动面板
- `Ctrl+b x` - 关闭当前面板
- `Ctrl+b z` - 切换面板缩放（最大化/最小化）
- `Ctrl+b {` - 将当前面板向左移动
- `Ctrl+b }` - 将当前面板向右移动

### 复制模式
- `Ctrl+b [` - 进入复制模式
- 箭头键或 vim 风格导航（h,j,k,l）移动
- `Space` - 开始选择
- `Enter` - 复制选择
- `Ctrl+b ]` - 粘贴复制的文本

## 实用示例

### 示例 1：运行长时间进程
tmux 最常见的用例之一是运行需要在终端断开连接后继续的长时间进程。

1. 启动一个新的命名 tmux 会话：
   ```sh
   tmux new -s long_process
   ```
   
   创建命名会话使以后更容易识别。

2. 运行你的长时间进程（例如，备份）：
   ```sh
   tar -czf backup.tar.gz /home/user/data
   ```
   
   这个进程将在 tmux 会话内运行。

3. 如果你需要断开连接：
   按 `Ctrl+b` 然后 `d` 从会话分离。
   
   分离不会停止进程 - 它继续在后台运行。这是允许持久性的关键机制。

4. 稍后，重新连接以检查进程：
   ```sh
   tmux attach -t long_process
   ```
   
   当你重新连接时，你会看到进程的当前状态，与你离开时完全相同。

### 示例 2：组织你的开发工作
Tmux 擅长组织具有多个相关任务的复杂工作流程。

1. 为你的项目启动一个新会话：
   ```sh
   tmux new -s project
   ```
   
   这为你的项目创建了一个专用工作空间。

2. 为不同任务创建窗口：
   - 按 `Ctrl+b c` 创建一个用于编码的窗口
   - 再次按 `Ctrl+b c` 创建一个用于日志的窗口
   - 再次按 `Ctrl+b c` 创建一个用于文档的窗口
   
   每个窗口就像一个标签，隔离你工作的不同方面。

3. 在窗口内，分割面板以进行多任务处理：
   - 按 `Ctrl+b %` 垂直分割编辑器和终端
   - 按 `Ctrl+b "` 水平分割输出
   
   面板允许你同时查看多个相关视图。

4. 在你组织的工作空间中导航：
   - 使用 `Ctrl+b n` 和 `Ctrl+b p` 在窗口之间切换
   - 使用 `Ctrl+b o` 在当前窗口的面板之间循环
   - 使用 `Ctrl+b w` 查看所有窗口的可视列表

这种组织允许你为每个项目维护一致的工作环境。当你返回到你的"项目"会话时，一切都与你离开时完全相同。

### 示例 3：协作会话
多个用户可以连接到同一个 tmux 会话，实现协作工作：

1. 用户 1 创建会话：
   ```sh
   tmux new -s collaboration
   ```

2. 用户 2（登录到同一系统）连接到同一会话：
   ```sh
   tmux attach -t collaboration
   ```
   
两个用户将看到相同的终端，一个用户的操作对另一个用户可见。这是可能的，因为 tmux 的客户端-服务器架构允许多个客户端连接到同一个会话。

## 自定义 Tmux

Tmux 可以通过其配置文件 `~/.tmux.conf` 高度自定义。这个文件在 tmux 启动时读取，允许你修改键绑定、外观、行为等。

### 理解 tmux 配置

tmux 配置文件使用简单的语法，每行是一个命令。注释以 `#` 开始。以下是带有解释的基本示例：

```bash
# 将前缀键设置为 Ctrl+a（类似 screen）
# 这通常更受欢迎，因为它更容易用一只手按下
unbind C-b          # 移除默认前缀键绑定
set -g prefix C-a   # 设置 Ctrl+a 为新前缀键
bind C-a send-prefix # 允许 Ctrl+a Ctrl+a 传递给程序

# 启用鼠标支持
# 启用后，你可以点击选择面板，调整面板大小，滚动
set -g mouse on

# 设置状态栏样式
# 自定义底部状态栏的外观
set -g status-style bg=black,fg=white

# 启用 256 色支持
# 这确保 tmux 内的程序可以正确显示颜色
set -g default-terminal "screen-256color"

# 增加滚动缓冲区
# 这允许你向上滚动并在每个面板中查看更多历史记录
set -g history-limit 10000

# 重新绑定面板切换以使用 vim 风格按键
# 这使导航对 vim 用户更直观
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R
```

### 应用配置更改

创建或修改 `~/.tmux.conf` 后，你有两个选择：

1. 重启 tmux（这将结束你的会话）
2. 在现有 tmux 会话中重新加载配置：
   ```sh
   tmux source-file ~/.tmux.conf
   ```

第二个选项更受欢迎，因为它在不中断工作的情况下应用更改。你甚至可以绑定一个键自动执行此操作：
```bash
# 使用前缀 + r 重新加载配置
bind r source-file ~/.tmux.conf
```

### 配置范围

注意许多配置命令中的 `-g` 标志。这代表"全局"，意味着设置适用于所有会话、窗口和面板。没有 `-g`，设置只适用于当前会话。

配置选项可以在不同级别设置：
- 全局（使用 `-g`）：适用于所有地方
- 会话：适用于一个会话
- 窗口：适用于一个窗口
- 面板：适用于一个面板

## 总结

Tmux 是一个非常强大的工具，用于管理终端会话，它采用客户端-服务器架构，提供会话持久性、窗口管理和面板组织。

### 关键机制

1. **客户端-服务器架构**：Tmux 作为服务器进程运行，独立于终端客户端管理会话，使会话能够在断开连接后持续存在。

2. **层次组织**：三级结构（会话 → 窗口 → 面板）为复杂工作流程提供强大的组织。

3. **前缀键系统**：前缀键机制允许 tmux 拦截命令，同时将所有其他按键传递给其中运行的程序。

4. **分离和重新连接**：能够从会话分离而不停止进程，这使 tmux 对远程工作和长时间运行的任务非常宝贵。

### 优势

- **持久性**：由于网络问题或终端关闭而永不丢失工作
- **组织**：使用窗口和面板构建复杂的工作流程
- **协作**：多个用户可以查看和交互同一会话
- **资源效率**：在单个终端窗口内运行多个终端
- **生产力**：使用键盘快捷键快速在任务之间导航

通过实践，tmux 可以显著提高你在终端环境中的生产力。初始学习曲线很快就会因轻松管理复杂终端工作流程而带来的效率提升得到回报。